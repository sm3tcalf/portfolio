<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenways Leaflet Demo</title>
    
    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>

    <!-- esri -->
    <script src="https://unpkg.com/esri-leaflet@3.0.16/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.2.8/dist/esri-leaflet-vector.js"></script>

    <!-- geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <!-- src geojson-->
    <script src="multimodal.js"></script>

</head>
    <style>
        #map {
            width: auto;
            height: 400px;
            background-color: lightgray;
        }
    </style>

<body>

<h2>Greenway Visualization Demo</h2>
<h3>Sam Metcalf - 5/23/25</h3>
        <h3 id = daYear>Year</h3>
        <input id = "yearSlider" type="range" name="year" min="1990" max="2025" oninput="moveSlider(this.value)" value="2025">
    <br></br>
    <div id="map"></div>


</body>
<script>

    let myCurrentSelectionYear = 2025 // the initial year to start the data

    const typeColors = {
        greenway: "#41AB5D",
        sidepath: "#BF40BF",
        trail: "brown",
        ssgreenway: "#00b2b2",
        sidewalk: "gray",
        other: "blue"
    };

    // defines functions to get color property, returns with styling

    function getColor(featureType) {
        return featureType == "Greenway" ? typeColors.greenway : // The getColor has a parameter d which in our case is the value of a Year. If the Year is less than the Year selected in the slider, then we get blue, otherwise it returns gray
               featureType == "Side Path" ? typeColors.sidepath :
               featureType == "Trail" ? typeColors.trail :
               featureType == "Street-Side Greenway" ? typeColors.ssgreenway :
               featureType == "Sidewalk (Greenway)" ? typeColors.sidewalk :     
        typeColors.other ; // other
    };

    function getDashes(featureStatus) { 
        return featureStatus === "Existing" ? '1' : '1 6'
    };

    function getOpacity(featureYear) { 
        return featureYear < myCurrentSelectionYear ? '1' : '0'
    };

    function myStyle(features) {
        console.log(features.properties.PLAN_YEAR, features.properties.TYPE, features.properties.TRAIL_NAME, features.properties.INSTALLED) // This the property with the DATE value. 
        return {
            "color": getColor(features.properties.TYPE), // the color is obtained from the getColor function
            "weight": 3,
            "dashArray": getDashes(features.properties.STATUS),
            "opacity" : getOpacity(features.properties.PLAN_YEAR)
        }
    };

    function myPopUp(features, layer) {
         var date = new Date(features.properties.TC_APPROVE);
            layer.bindPopup("<b>" + features.properties.TRAIL_NAME + "</b><br>" +
                "Status: " + features.properties.STATUS + "<br>" +
                "Path Type: " + features.properties.TYPE + "<br>" +
                "Corridor: " + features.properties.CORRIDOR + "<br>" +
                "Year Planned: " + features.properties.PLAN_YEAR + "<br>"
         )
    }

    function myFilter(features, type, status) {
        return (features.properties.TYPE == type &&
                features.properties.STATUS == status)
    }

    function resetAll(listOfLayers) {
        for (let x in listOfLayers) {
            listOfLayers[x].resetStyle()
        }
    }

    // creating geoJSON layers for each type, add to respective

    // const greenways = L.geoJSON(multimodal, {
    //     style: myStyle, // styling according to myStyle() defined function
    //     onEachFeature: myPopUp,
    //     filter: function(features) {
    //         return (features.properties.TYPE === "Greenway")
    //     }
    // })
    const apexPedPaths = "https://services1.arcgis.com/nry3yyvaEfskMEXA/arcgis/rest/services/Apex_Bicycle_and_Pedestrian_System/FeatureServer/2";

    const greenways = L.esri.featureLayer({
        url: apexPedPaths,
        style: myStyle, // styling according to myStyle() defined function
        onEachFeature: myPopUp,
        where: "TYPE = 'Greenway'"
    });

    const sidepaths = L.esri.featureLayer({
        url: apexPedPaths,
        style: myStyle, // styling according to myStyle() defined function
        onEachFeature: myPopUp,
        where: "TYPE = 'Side Path'"
    })

    const trails = L.esri.featureLayer({
        url: apexPedPaths,
        style: myStyle, // styling according to myStyle() defined function
        onEachFeature: myPopUp,
        where: "TYPE = 'Trail'"
    })

    const ssgreenways = L.esri.featureLayer({
        url: apexPedPaths,
        style: myStyle, // styling according to myStyle() defined function
        onEachFeature: myPopUp,
        where: "TYPE = 'Street-Side Greenway'"
    })

    const sidewalks = L.esri.featureLayer({
        url: apexPedPaths,
        style: myStyle, // styling according to myStyle() defined function
        onEachFeature: myPopUp,
        where: "TYPE = 'Sidewalk (Greenway)'"
    })

    const att = L.esri.featureLayer({
        url: apexPedPaths,
        style: myStyle, // styling according to myStyle() defined function
        onEachFeature: myPopUp,
        where: "TYPE = 'Greenway-Equestrian'"
    })

    // const att = L.geoJSON(multimodal, {
    //     style: myStyle, // styling according to myStyle() defined function
    //     onEachFeature: myPopUp,
    //     filter: function(features, layer) {
    //         return (features.properties.TYPE === "Side Path")
    //     }
    // })

     layerList = [greenways, sidepaths, trails, ssgreenways, sidewalks, att]

    const streets = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	subdomains: 'abcd',
	maxZoom: 20
});
    
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    const overlayMaps = {
        [`<span style='color: ${typeColors.greenway}'>Greenways</span>`]: greenways,
        [`<span style='color: ${typeColors.sidepath}'>Side Paths</span>`] : sidepaths,
        [`<span style='color: ${typeColors.trail}'>Trails</span>`] : trails,
        [`<span style='color: ${typeColors.ssgreenway}'>Street-Side Greenways</span>`] : ssgreenways,
        [`<span style='color: ${typeColors.sidewalk}'>Sidewalks</span>`] : sidewalks,
        [`<span style='color: ${typeColors.other}'>American Tobacco Trail</span>`] : att
    }

    const baseMaps = {
        "Streets": streets,
        "Satellite": satellite
    }

    const map = L.map('map', {
        center: [35.73230144892665, -78.87270608267929],
        zoom: 11,
        layers: [greenways, att, streets]
    })
    
    map.setMaxBounds(map.getBounds());

    const layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

    function moveSlider(value) { // function called by the slider that receives the value from the slider. 
        // console.log(value)
        document.getElementById('daYear').innerHTML = 'Year: ' + value // assign the value of year into the text
        myCurrentSelectionYear = value // reassign the new selected year value
        resetAll(layerList)
        // console.log(myCurrentSelectionYear)
    }

    moveSlider(myCurrentSelectionYear) // run the function moveSlider with the year 2025 to start with our first year 

    window.onload = function() {
        document.getElementById('yearSlider').value = 2025;  
    }; // on refresh, reset to 2025

    new L.Control.Geocoder().addTo(map);

</script>   
</html>